# Ralph Progress Log - v2
Started: 2026-01-08

## Codebase Patterns
- Supabase migrations in `supabase/migrations/` numbered sequentially (001_, 002_, etc.)
- RLS policies follow pattern: "Users can [action] own [table]" naming
- Use TEXT[] for arrays (like quote_ids)
- visibility TEXT with CHECK constraint for enum-like values
- update_updated_at_column() trigger function exists - reuse it for new tables
- All tables use UUID primary key with gen_random_uuid()
- Foreign keys reference auth.users(id) with ON DELETE CASCADE
- useAuth hook: `import { useAuth } from '@/hooks/useAuth'` provides `{ user, isLoading, isSupabaseConfigured, isSignedIn }`
- ActionButtons component takes optional callbacks + boolean props to conditionally render buttons

---

## 2026-01-08 - US-C01: Create collections table in Supabase
- Created `supabase/migrations/002_collections.sql`
- Collections table: id, user_id, title, description, quote_ids[], visibility, timestamps
- RLS enabled with 5 policies:
  - Users can view/insert/update/delete own collections
  - Public collections readable by all authenticated users
- Added indexes on user_id and visibility
- Reused existing update_updated_at_column() trigger
- **Learnings:**
  - Existing migration 001_initial_schema.sql has update_updated_at_column() function
  - Use TEXT with CHECK constraint for enum-like values (not Postgres ENUM)
  - Pattern: CREATE TABLE -> CREATE INDEX -> ALTER TABLE ENABLE RLS -> CREATE POLICY -> CREATE TRIGGER
---

## 2026-01-08 - US-C02: Create collection_follows table in Supabase
- Created `supabase/migrations/003_collection_follows.sql`
- collection_follows table: user_id, collection_id, followed_at with composite primary key
- RLS enabled with 4 policies:
  - Users can view own follows
  - Anyone can view follows on public collections (for follower counts)
  - Users can follow collections (insert)
  - Users can unfollow collections (delete)
- Added indexes on collection_id and user_id for efficient lookups
- No updated_at trigger needed (follows are immutable once created)
- **Learnings:**
  - Composite primary keys use: PRIMARY KEY (col1, col2) syntax
  - For junction tables, index both foreign key columns separately
  - RLS subqueries can reference other tables for complex policies
---

## 2026-01-08 - US-C03: Add 'Add to collection' button on quote display
- Modified `src/components/ActionButtons.tsx`:
  - Added `onAddToCollection` callback prop
  - Added `isSignedIn` boolean prop
  - Added "Collect" button with + icon (only visible when signed in)
- Modified `src/app/page.tsx`:
  - Added `useAuth` hook to get `isSignedIn` state
  - Added `showAddToCollectionModal` state (for US-C04)
  - Added `handleAddToCollection` handler that sets modal state
  - Passed new props to ActionButtons component
- **Learnings:**
  - `useAuth` hook from `@/hooks/useAuth` provides `isSignedIn` boolean
  - ActionButtons conditionally renders buttons based on props
  - Button pattern: icon SVG + label text, flex-col, same styling as other action buttons
---

## 2026-01-08 - US-C04: Create 'Add to collection' modal
- Created `src/components/AddToCollectionModal.tsx`:
  - Modal lists user's collections fetched from Supabase
  - Radio button selection (one collection at a time)
  - Green check mark on collections that already contain the quote
  - Disabled selection for already-added collections
  - Confirm button updates quote_ids array in Supabase
  - Shows success toast via onSuccess callback
- Added `Collection` type to `src/types/index.ts`:
  - id, user_id, title, description, quote_ids[], visibility, timestamps
  - CollectionVisibility type: 'private' | 'public'
- Integrated modal into `src/app/page.tsx`:
  - Dynamic import for lazy loading
  - Connected to showAddToCollectionModal state from US-C03
  - onSuccess shows toast notification
- **Learnings:**
  - Use `aria-label` instead of `title` prop on SVG elements (TypeScript SVGProps)
  - Modal pattern: fixed inset-0, bg-black/50, escape key handler, click-outside-to-close
  - Supabase queries: `.from().select().eq().order()` with destructured { data, error }
  - Dynamic imports: `dynamic(() => import().then(mod => ({ default: mod.Component })), { ssr: false })`
---

## 2026-01-08 - US-C05: Create 'New collection' form
- Modified `src/components/AddToCollectionModal.tsx`:
  - Added "+ New Collection" button with dashed border below collection list
  - Clicking button shows inline form with:
    - Title field (required) with placeholder
    - Description textarea (optional)
    - Visibility toggle buttons (Private/Public) with lock/globe icons
    - Cancel/Create action buttons
  - Create button inserts new collection to Supabase via `.insert().select().single()`
  - New collection auto-added to list and auto-selected
  - Form resets when cancelled or after successful creation
- **Learnings:**
  - Supabase insert + return data: `.insert({...}).select().single()` returns the created row
  - Toggle button pattern: flex buttons with conditional border/bg classes
  - Form inside modal: use separate state for form visibility (showNewForm) vs modal visibility (isOpen)
  - Reset form state in useEffect when modal closes, not just on cancel
---

## 2026-01-08 - US-C06: Create My Collections page
- Created `src/app/collections/page.tsx`:
  - Lists user's collections with title, quote count, visibility icon
  - Shows follower count for public collections with user icon
  - Links to collection detail page at /collections/[id]
  - Sign-in prompt for unauthenticated users
  - Empty state with CTA to browse quotes
  - Loading skeleton while fetching
- Modified `src/components/Navigation.tsx`:
  - Added Collections nav item between Favorites and Journeys
  - Used collection/box icon for visual consistency
- **Learnings:**
  - Supabase aggregates: `.select('*, collection_follows(count)')` returns `{ count: number }[]`
  - Need explicit type casting for aggregate responses: `(data as CollectionRow[])`
  - Use `getSupabase()` not `createClient` - check for null before querying
  - Follow FavoritesPage pattern for page structure: loading → empty → content states
---
