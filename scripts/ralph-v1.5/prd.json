{
  "project": "Quotidian",
  "branchName": "ralph/v1.5-sync",
  "description": "V1.5: Sync & Sharing - Accounts, cross-device sync, share cards, email digest",
  "userStories": [
    {
      "id": "US-S01",
      "title": "Set up Supabase project and auth",
      "description": "As a developer, I need Supabase configured for auth and data.",
      "acceptanceCriteria": [
        "Create Supabase project",
        "Install @supabase/supabase-js",
        "Create src/lib/supabase.ts with client initialization",
        "Configure environment variables (NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY)",
        "Add .env.local to .gitignore",
        "npm run typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Supabase project setup is manual - .env.local.example provided. Client uses lazy initialization to avoid build failures when env vars not set."
    },
    {
      "id": "US-S02",
      "title": "Create account settings page",
      "description": "As a user, I want to manage my account.",
      "acceptanceCriteria": [
        "Create src/app/account/page.tsx",
        "Show signed-out state with sign-in prompt",
        "Show signed-in state with email and sign-out button",
        "Add link in navigation or settings",
        "npm run typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Account page at /account. Link added to settings page. Shows 3 states: Supabase not configured, signed out, signed in."
    },
    {
      "id": "US-S03",
      "title": "Implement magic link sign-in flow",
      "description": "As a user, I want to sign in without a password.",
      "acceptanceCriteria": [
        "Email input field on account page",
        "Send magic link button",
        "Call Supabase auth.signInWithOtp({ email })",
        "Show 'Check your email' message after sending",
        "Handle magic link callback in app",
        "npm run typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Sign-in page at /account/signin. Callback handler at /account/callback parses URL hash for tokens."
    },
    {
      "id": "US-S04",
      "title": "Implement sign-out flow",
      "description": "As a user, I want to sign out.",
      "acceptanceCriteria": [
        "Sign out button on account page",
        "Call Supabase auth.signOut()",
        "Clear any cached auth state",
        "Redirect to account page showing signed-out state",
        "Local data remains intact",
        "npm run typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "SignOutButton component already implemented in US-S02. Uses onAuthStateChange to auto-update UI on sign-out. Local IndexedDB data untouched."
    },
    {
      "id": "US-S05",
      "title": "Show signed-in state throughout app",
      "description": "As a user, I want to see my signed-in status.",
      "acceptanceCriteria": [
        "Create useAuth hook to track auth state",
        "Show sync indicator in navigation when signed in",
        "Update account page dynamically on auth change",
        "npm run typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "useAuth hook in src/hooks/useAuth.ts. Green dot indicator on Settings nav item when signed in. Account page refactored to use useAuth hook."
    },
    {
      "id": "US-S06",
      "title": "Create Supabase schema (tables, RLS)",
      "description": "As a developer, I need database tables for sync.",
      "acceptanceCriteria": [
        "Create preferences table (user_id, name, notification_time, etc.)",
        "Create journal_entries table (user_id, quote_id, content, timestamps)",
        "Create favorites table (user_id, quote_id, saved_at)",
        "Create quote_history table (user_id, quote_id, shown_at)",
        "Create signals table (user_id, quote_id, signal, timestamp)",
        "Enable RLS on all tables",
        "Create policies: users can only access their own data",
        "npm run typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Schema in supabase/migrations/001_initial_schema.sql. TypeScript types in src/types/supabase.ts. All tables have RLS with user-scoped policies."
    },
    {
      "id": "US-S07",
      "title": "Create sync service for preferences",
      "description": "As a signed-in user, I want my preferences synced.",
      "acceptanceCriteria": [
        "Create src/lib/sync/preferences.ts",
        "pushPreferences(): upload local to Supabase",
        "pullPreferences(): download from Supabase to local",
        "Handle merge conflicts (last-write-wins by updated_at)",
        "npm run typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Sync service at src/lib/sync/preferences.ts. Functions: pushPreferences(), pullPreferences(), syncPreferences(). Uses upsert with last-write-wins based on updated_at timestamp. Preserves digest_enabled setting when updating existing remote."
    },
    {
      "id": "US-S08",
      "title": "Create sync service for journal entries",
      "description": "As a signed-in user, I want my reflections synced.",
      "acceptanceCriteria": [
        "Create src/lib/sync/journal.ts",
        "pushJournalEntries(): upload local to Supabase",
        "pullJournalEntries(): download from Supabase to local",
        "Handle merge conflicts (last-write-wins)",
        "npm run typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Sync service at src/lib/sync/journal.ts. Push/pull/sync functions with last-write-wins conflict resolution based on updated_at timestamp. Uses quote_id as unique key per user."
    },
    {
      "id": "US-S09",
      "title": "Create sync service for favorites",
      "description": "As a signed-in user, I want my favorites synced.",
      "acceptanceCriteria": [
        "Create src/lib/sync/favorites.ts",
        "pushFavorites(): upload local to Supabase",
        "pullFavorites(): download from Supabase to local",
        "Handle add/remove correctly",
        "npm run typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Sync service at src/lib/sync/favorites.ts. Push adds missing to remote, removes unfavorited. Pull adds missing to local, removes deleted remotely. syncFavorites() does pull-then-push for bidirectional sync."
    },
    {
      "id": "US-S10",
      "title": "Create sync service for quote history",
      "description": "As a signed-in user, I want my history synced.",
      "acceptanceCriteria": [
        "Create src/lib/sync/history.ts",
        "pushHistory(): upload local to Supabase",
        "pullHistory(): download from Supabase to local",
        "Deduplicate on sync",
        "npm run typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Sync service at src/lib/sync/history.ts. Uses quoteId+shownAt as unique key for deduplication. History is append-only (no deletes/conflicts). Push/pull/sync functions follow same pattern as favorites."
    },
    {
      "id": "US-S11",
      "title": "Implement offline queue for pending syncs",
      "description": "As a user, I want changes saved when offline.",
      "acceptanceCriteria": [
        "Create pending_syncs table in IndexedDB",
        "Queue changes when offline",
        "Process queue when online",
        "Show sync indicator when queue not empty",
        "npm run typecheck passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": "Queue in src/lib/sync/queue.ts. Functions: queueSync(), processPendingSyncs(), syncOrQueue(), syncAll(). useSyncStatus hook provides reactive UI state. Navigation SyncIndicator shows green (synced), yellow (pending), or blue pulsing (syncing)."
    },
    {
      "id": "US-S12",
      "title": "Implement conflict resolution (last-write-wins)",
      "description": "As a user, I don't want to lose data on sync conflicts.",
      "acceptanceCriteria": [
        "Compare updated_at timestamps on conflicts",
        "Keep newer version",
        "Log conflicts for debugging",
        "No user-facing merge dialogs (automatic)",
        "npm run typecheck passes"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Conflict resolution module at src/lib/sync/conflicts.ts. resolveConflict() compares timestamps and logs to console.debug. In-memory log available via getConflictLog() and getConflictSummary(). Preferences and journal sync services refactored to use the module."
    },
    {
      "id": "US-S13",
      "title": "Create share card generator (canvas)",
      "description": "As a developer, I need to generate share images.",
      "acceptanceCriteria": [
        "Create src/lib/shareCard.ts",
        "generateShareCard(quote): returns Blob",
        "Canvas size: 1200x630 (social preview)",
        "Background: #fafaf8",
        "Quote text in serif, centered",
        "Author attribution below",
        "quotidian.app branding at bottom",
        "npm run typecheck passes"
      ],
      "priority": 13,
      "passes": true,
      "notes": "Share card generator at src/lib/shareCard.ts. generateShareCard(quote) returns PNG Blob. Uses HTML5 Canvas with 1200x630 dimensions. Auto-wraps text and calculates optimal font size. Georgia serif for quote text, system sans-serif for branding."
    },
    {
      "id": "US-S14",
      "title": "Add share button to quote display",
      "description": "As a user, I want to share quotes.",
      "acceptanceCriteria": [
        "Add share icon button to action buttons",
        "Clicking opens share options modal",
        "Generate share card on demand",
        "npm run typecheck passes"
      ],
      "priority": 14,
      "passes": true,
      "notes": "Share button added to ActionButtons component. ShareModal component shows preview of generated share card. Buttons for copy/download/share are placeholder (implemented in US-S15, US-S16, US-S17)."
    },
    {
      "id": "US-S15",
      "title": "Implement copy to clipboard",
      "description": "As a user, I want to copy the share image.",
      "acceptanceCriteria": [
        "Copy image to clipboard button",
        "Use Clipboard API with blob",
        "Show success toast",
        "Handle browsers that don't support image clipboard",
        "npm run typecheck passes"
      ],
      "priority": 15,
      "passes": true,
      "notes": "Copy button in ShareModal uses ClipboardItem API for PNG blob. Falls back to text copy if image clipboard not supported. Toast shows success/error status with auto-dismiss."
    },
    {
      "id": "US-S16",
      "title": "Implement download as PNG",
      "description": "As a user, I want to download the share image.",
      "acceptanceCriteria": [
        "Download button in share modal",
        "Downloads PNG with filename: quotidian-[quote-id].png",
        "Works on mobile and desktop",
        "npm run typecheck passes"
      ],
      "priority": 16,
      "passes": true,
      "notes": "Download button in ShareModal generates fresh PNG blob, creates invisible anchor element with download attribute, triggers click, then cleans up. Filename format: quotidian-{quote.id}.png. Status indicators for downloading/success/error."
    },
    {
      "id": "US-S17",
      "title": "Implement native share (Web Share API)",
      "description": "As a mobile user, I want to use native sharing.",
      "acceptanceCriteria": [
        "Detect Web Share API support",
        "Share button uses native share sheet when available",
        "Share includes image and quote text",
        "Fallback to copy/download on unsupported browsers",
        "npm run typecheck passes"
      ],
      "priority": 17,
      "passes": true,
      "notes": "Share button in ShareModal uses Web Share API with navigator.canShare() feature detection. Shares image + text when supported, falls back to text-only sharing, and displays error message directing to Copy/Download on unsupported browsers. User cancellation handled gracefully (no error shown)."
    },
    {
      "id": "US-S18",
      "title": "Set up Resend integration",
      "description": "As a developer, I need email sending capability.",
      "acceptanceCriteria": [
        "Create Resend account",
        "Add RESEND_API_KEY to environment",
        "Create src/lib/email.ts with send function",
        "Verify sending works with test email",
        "npm run typecheck passes"
      ],
      "priority": 18,
      "passes": true,
      "notes": "Resend installed. src/lib/email.ts has sendEmail(), sendTestEmail(), isResendConfigured(). Uses lazy init pattern. RESEND_API_KEY added to .env.local.example."
    },
    {
      "id": "US-S19",
      "title": "Create digest email template",
      "description": "As a developer, I need an email template for weekly digest.",
      "acceptanceCriteria": [
        "Create email template with React Email or HTML",
        "Include: greeting, favorite quote of week, reflection highlight, CTA",
        "Matches app aesthetic",
        "Responsive for email clients",
        "npm run typecheck passes"
      ],
      "priority": 19,
      "passes": true,
      "notes": "Template at src/lib/email/digestTemplate.ts. generateDigestEmail() returns {html, text, subject}. Includes greeting, quote of week, reflection highlight, week stats, CTA button, unsubscribe link. Georgia serif font, warm #fafaf8 background, responsive tables for email clients."
    },
    {
      "id": "US-S20",
      "title": "Create Supabase Edge Function for weekly send",
      "description": "As a user with digest enabled, I want weekly emails.",
      "acceptanceCriteria": [
        "Create Supabase Edge Function",
        "Cron: every Sunday 8am UTC",
        "Query users with digest enabled",
        "Fetch their week's data",
        "Send personalized email via Resend",
        "npm run typecheck passes"
      ],
      "priority": 20,
      "passes": true,
      "notes": "Edge Function at supabase/functions/weekly-digest/index.ts. Queries preferences for digest_enabled users, fetches week's data (favorites, journal, history), builds personalized digest, sends via Resend API. Cron setup via pg_cron documented in README. API routes /api/quotes and /api/quotes/[id] added for quote data access."
    },
    {
      "id": "US-S21",
      "title": "Add digest settings toggle",
      "description": "As a user, I want to enable/disable email digest.",
      "acceptanceCriteria": [
        "Add toggle in settings: 'Send weekly digest'",
        "Requires signed-in account",
        "Show email that will receive digest",
        "Save preference to Supabase",
        "npm run typecheck passes"
      ],
      "priority": 21,
      "passes": true,
      "notes": "Toggle added to settings page. Shows only when signed in with Supabase. Displays user email. Uses getDigestEnabled/setDigestEnabled functions in sync/preferences.ts. Sign-in prompt shown when not authenticated."
    },
    {
      "id": "US-S22",
      "title": "Implement unsubscribe flow",
      "description": "As a user, I want to unsubscribe from emails.",
      "acceptanceCriteria": [
        "Include unsubscribe link in email footer",
        "Link goes to /unsubscribe?token=xxx",
        "Validates token and disables digest",
        "Shows confirmation page",
        "npm run typecheck passes"
      ],
      "priority": 22,
      "passes": false,
      "notes": ""
    }
  ]
}
