# V1.5 Spec: Sync & Sharing

**Goal:** Beyond single device. Optional accounts, cloud sync, sharing, email digest.

---

## Auth: Magic Link

### Approach
Email magic link (passwordless). OAuth later.

### Flow
```
┌─────────────────────────────────────────┐
│  Settings > Account                     │
│                                         │
│  Sync your data across devices          │
│                                         │
│  Email: [_____________________]         │
│                                         │
│  [Send Magic Link]                      │
│                                         │
│  ─────────────────────────────          │
│  Your data stays on-device until you    │
│  create an account. No account needed   │
│  to use Quotidian.                      │
└─────────────────────────────────────────┘

After clicking link in email:
┌─────────────────────────────────────────┐
│  ✓ You're signed in                     │
│                                         │
│  Syncing your reflections...            │
│  ████████████░░░░ 67%                   │
│                                         │
│  12 reflections                         │
│  8 favorites                            │
│  Your preferences                       │
└─────────────────────────────────────────┘
```

### Tech
- Supabase Auth (magic link built-in)
- JWT stored in localStorage
- Auto-refresh tokens
- Sign out clears cloud data reference (local stays)

---

## Backend: Supabase

### Schema
```sql
-- Users (managed by Supabase Auth)

-- Preferences
create table preferences (
  user_id uuid references auth.users primary key,
  name text not null,
  notification_time text default '08:00',
  notifications_enabled boolean default true,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- Journal Entries
create table journal_entries (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users not null,
  quote_id text not null,
  content text not null,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- Favorites
create table favorites (
  user_id uuid references auth.users,
  quote_id text,
  saved_at timestamptz default now(),
  primary key (user_id, quote_id)
);

-- Quote History
create table quote_history (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users not null,
  quote_id text not null,
  shown_at timestamptz default now()
);

-- Signals (for algorithm)
create table signals (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users not null,
  quote_id text not null,
  signal text not null,
  created_at timestamptz default now()
);

-- RLS policies
alter table preferences enable row level security;
alter table journal_entries enable row level security;
alter table favorites enable row level security;
alter table quote_history enable row level security;
alter table signals enable row level security;

-- Users can only access their own data
create policy "Users own their preferences"
  on preferences for all using (auth.uid() = user_id);
-- (repeat for other tables)
```

### Sync Strategy
```
Local-first with cloud backup:

1. All writes go to IndexedDB first (instant)
2. If signed in, queue sync to Supabase
3. On app open, pull latest from cloud
4. Conflict resolution: last-write-wins by updated_at
5. Offline: queue syncs, process when online
```

---

## Share Cards

### Approach
Client-side canvas rendering. No server needed.

### Design
```
┌─────────────────────────────────────────┐
│                                         │
│  "We suffer more often in              │
│   imagination than in reality."         │
│                                         │
│                    — Seneca             │
│                                         │
│  ───────────────────────────────────    │
│  quotidian.app                          │
└─────────────────────────────────────────┘

- 1200x630 (social preview size)
- Warm background (#fafaf8)
- Serif quote text
- Subtle branding at bottom
```

### Implementation
```typescript
async function generateShareCard(quote: Quote): Promise<Blob> {
  const canvas = document.createElement('canvas');
  canvas.width = 1200;
  canvas.height = 630;
  const ctx = canvas.getContext('2d');

  // Background
  ctx.fillStyle = '#fafaf8';
  ctx.fillRect(0, 0, 1200, 630);

  // Quote text (word-wrapped)
  ctx.font = 'italic 48px Georgia, serif';
  ctx.fillStyle = '#1a1a1a';
  wrapText(ctx, `"${quote.text}"`, 100, 200, 1000, 60);

  // Author
  ctx.font = '32px Inter, sans-serif';
  ctx.fillText(`— ${quote.author}`, 100, 480);

  // Branding
  ctx.font = '24px Inter, sans-serif';
  ctx.fillStyle = '#888';
  ctx.fillText('quotidian.app', 100, 580);

  return new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
}
```

### UX
- Share button on quote → generates card
- Options: Copy to clipboard, Download, Share (native share sheet)
- Loading state while generating

---

## Email Digest

### Approach
Weekly summary, sent via Supabase Edge Functions + Resend.

### Content
```
Subject: Your week in reflection ✨

Good morning, John.

This week you reflected on 5 quotes.

Your favorite this week:
"The obstacle is the way."
— Marcus Aurelius

─────────────────────────────

Reflection highlight:
"This reminded me of the project at work..."
(on "We suffer more in imagination...")

─────────────────────────────

See you tomorrow,
Quotidian

[Open Quotidian]
```

### Settings
```
┌─────────────────────────────────────────┐
│  Email Digest                           │
│                                         │
│  Weekly summary of your reflections     │
│                                         │
│  [x] Send weekly digest                 │
│      Every Sunday at 8:00 AM            │
│                                         │
│  [ ] Include reflection excerpts        │
└─────────────────────────────────────────┘
```

### Tech
- Supabase Edge Function (cron: Sundays 8am UTC)
- Resend for email delivery
- Unsubscribe link in footer

---

## User Stories (Ralph-able)

### Auth
- US-S01: Set up Supabase project and auth
- US-S02: Create account settings page
- US-S03: Implement magic link sign-in flow
- US-S04: Implement sign-out flow
- US-S05: Show signed-in state in settings

### Database
- US-S06: Create Supabase schema (tables, RLS)
- US-S07: Create sync service for preferences
- US-S08: Create sync service for journal entries
- US-S09: Create sync service for favorites
- US-S10: Create sync service for quote history
- US-S11: Implement offline queue for pending syncs
- US-S12: Implement conflict resolution (last-write-wins)

### Share Cards
- US-S13: Create share card generator (canvas)
- US-S14: Add share button to quote display
- US-S15: Implement copy to clipboard
- US-S16: Implement download as PNG
- US-S17: Implement native share (Web Share API)

### Email Digest
- US-S18: Set up Resend integration
- US-S19: Create digest email template
- US-S20: Create Supabase Edge Function for weekly send
- US-S21: Add digest settings toggle
- US-S22: Implement unsubscribe flow

---

## Open Questions

- Supabase free tier limits? (50k monthly active users, should be fine)
- Email sender domain? (need quotidian.app domain for deliverability)
- Data export feature? (GDPR-friendly, add to V2?)
